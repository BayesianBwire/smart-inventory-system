{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2>üì¶ Smart Inventory Dashboard</h2>

    <!-- Filter Section -->
    <form method="get" class="form-inline mb-3">
        <select name="category" class="form-control mr-2">
            <option value="">All Categories</option>
            {% for c in categories %}
                <option value="{{ c }}" {% if c == selected_category %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
        </select>
        <label class="form-check-label mx-2">
            <input type="checkbox" name="low_stock" value="1" {% if low_stock_filter == '1' %}checked{% endif %}>
            Low Stock Only
        </label>
        <button type="submit" class="btn btn-primary ml-2">Apply</button>
    </form>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-light border-primary">
                <div class="card-body">
                    <h5 class="card-title">Total Items</h5>
                    <p class="card-text">{{ total_items }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-light border-success">
                <div class="card-body">
                    <h5 class="card-title">Total Stock Value (Ksh)</h5>
                    <p class="card-text">{{ total_value }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-light border-warning">
                <div class="card-body">
                    <h5 class="card-title">Total Expected Profit (Ksh)</h5>
                    <p class="card-text">{{ total_profit }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Featured Products -->
    <div class="row mb-4">
        {% if most_valuable %}
        <div class="col-md-4">
            <div class="card border-info">
                <div class="card-header">üí∞ Most Valuable</div>
                <div class="card-body">
                    <h6>{{ most_valuable.product_name }}</h6>
                    <p>Ksh {{ most_valuable.price }} √ó {{ most_valuable.quantity }}</p>
                </div>
            </div>
        </div>
        {% endif %}
        {% if top_rated %}
        <div class="col-md-4">
            <div class="card border-info">
                <div class="card-header">‚≠ê Top Rated</div>
                <div class="card-body">
                    <h6>{{ top_rated.product_name }}</h6>
                    <p>Rating: {{ top_rated.average_rating }}</p>
                </div>
            </div>
        </div>
        {% endif %}
        {% if most_reviewed %}
        <div class="col-md-4">
            <div class="card border-info">
                <div class="card-header">üó£ Most Reviewed</div>
                <div class="card-body">
                    <h6>{{ most_reviewed.product_name }}</h6>
                    <p>{{ most_reviewed.reviews_count }} reviews</p>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Product Table -->
    <table class="table table-bordered table-striped">
        <thead class="thead-dark">
            <tr>
                <th>Image</th>
                <th>Product</th>
                <th>Code</th>
                <th>Category</th>
                <th>Price</th>
                <th>Cost Price</th>
                <th>Quantity</th>
                <th>Profit</th>
            </tr>
        </thead>
        <tbody>
            {% for product in products %}
            <tr>
                <td>
                    {% if product.image_url %}
                    <img src="{{ product.image_url }}" alt="Image" style="width: 60px; height: auto;">
                    {% else %}
                    <small>No image</small>
                    {% endif %}
                </td>
                <td>{{ product.product_name }}</td>
                <td>{{ product.product_code }}</td>
                <td>{{ product.category }}</td>
                <td>Ksh {{ product.price }}</td>
                <td>Ksh {{ product.cost_price }}</td>
                <td>{{ product.quantity }}</td>
                <td>Ksh {{ (product.price - product.cost_price) * product.quantity }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination -->
    <nav>
        <ul class="pagination">
            {% for p in range(1, total_pages + 1) %}
            <li class="page-item {% if p == current_page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('inventory', page=p, category=selected_category, low_stock=low_stock_filter) }}">{{ p }}</a>
            </li>
            {% endfor %}
        </ul>
    </nav>

    <!-- Charts -->
    <div class="row mt-4">
        <div class="col-md-6">
            {{ bar_div | safe }}
        </div>
        <div class="col-md-6">
            {{ pie_div | safe }}
        </div>
    </div>

    <!-- Export -->
    <div class="mt-4">
        <a href="{{ url_for('download_inventory') }}" class="btn btn-success">üì• Download Inventory (Excel)</a>
    </div>

    <!-- Add Product Form -->
    <hr>
    <h4>Add New Product</h4>
    <form action="{{ url_for('add_product') }}" method="POST">
        <div class="form-row">
            <div class="form-group col-md-3">
                <input type="text" name="product_code" class="form-control" placeholder="Product Code" required>
            </div>
            <div class="form-group col-md-3">
                <input type="text" name="product_name" class="form-control" placeholder="Product Name" required>
            </div>
            <div class="form-group col-md-2">
                <input type="text" name="category" class="form-control" placeholder="Category" required>
            </div>
            <div class="form-group col-md-2">
                <input type="number" name="price" class="form-control" placeholder="Price" required>
            </div>
            <div class="form-group col-md-2">
                <input type="number" name="cost_price" class="form-control" placeholder="Cost Price">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-2">
                <input type="number" name="quantity" class="form-control" placeholder="Quantity" required>
            </div>
            <div class="form-group col-md-6">
                <input type="text" name="description" class="form-control" placeholder="Description">
            </div>
            <div class="form-group col-md-4">
                <input type="text" name="image_url" class="form-control" placeholder="Image URL">
            </div>
        </div>
        <button type="submit" class="btn btn-primary">‚ûï Add Product</button>
    </form>
</div>
{% endblock %}
