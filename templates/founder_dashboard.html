{% extends "base.html" %}
{% block content %}

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-crown text-warning me-2"></i>Founder Dashboard</h2>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary" onclick="exportData()">
            <i class="fas fa-download me-2"></i>Export Data
          </button>
          <button class="btn btn-primary" onclick="refreshData()">
            <i class="fas fa-sync-alt me-2"></i>Refresh
          </button>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card bg-primary text-white">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                  <h5 class="card-title">Total Companies</h5>
                  <h2 class="mb-0">{{ total_companies }}</h2>
                </div>
                <div class="fs-1 opacity-50">
                  <i class="fas fa-building"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-3">
          <div class="card bg-success text-white">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                  <h5 class="card-title">Active Users</h5>
                  <h2 class="mb-0">{{ total_users }}</h2>
                </div>
                <div class="fs-1 opacity-50">
                  <i class="fas fa-users"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-3">
          <div class="card bg-info text-white">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                  <h5 class="card-title">Free Plans</h5>
                  <h2 class="mb-0">{{ free_plans }}</h2>
                </div>
                <div class="fs-1 opacity-50">
                  <i class="fas fa-gift"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-3">
          <div class="card bg-warning text-white">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                  <h5 class="card-title">Paid Plans</h5>
                  <h2 class="mb-0">{{ paid_plans }}</h2>
                </div>
                <div class="fs-1 opacity-50">
                  <i class="fas fa-star"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Companies Table -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-list me-2"></i>Companies Overview
          </h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover" id="companiesTable">
              <thead class="table-dark">
                <tr>
                  <th>Unique ID</th>
                  <th>Company Name</th>
                  <th>Industry</th>
                  <th>Admin</th>
                  <th>Phone</th>
                  <th>Employees</th>
                  <th>Active Modules</th>
                  <th>Plan</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for company in companies %}
                <tr>
                  <td>
                    <span class="badge bg-primary fs-6">{{ company.unique_id }}</span>
                  </td>
                  <td>
                    <strong>{{ company.name }}</strong>
                    {% if company.email %}
                    <br><small class="text-muted">{{ company.email }}</small>
                    {% endif %}
                  </td>
                  <td>
                    {% if company.industry %}
                    <span class="badge bg-secondary">{{ company.industry.title() }}</span>
                    {% else %}
                    <span class="text-muted">Not specified</span>
                    {% endif %}
                  </td>
                  <td>
                    {% for user in company.users %}
                      {% if user.role == 'admin' %}
                      <div>
                        <strong>{{ user.full_name }}</strong>
                        <br><small class="text-muted">{{ user.email }}</small>
                      </div>
                      {% endif %}
                    {% endfor %}
                  </td>
                  <td>
                    {% if company.phone %}
                      {{ company.phone }}
                    {% else %}
                      <span class="text-muted">Not provided</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge bg-info">{{ company.users|length }}</span>
                  </td>
                  <td>
                    {% if company.subscription and company.subscription[0] %}
                      {% set active_modules = company.subscription[0].get_active_modules_list() %}
                      {% if active_modules %}
                        {% for module in active_modules %}
                          <span class="badge bg-success me-1">{{ module }}</span>
                        {% endfor %}
                        <br><small class="text-muted">{{ active_modules|length }}/{{ company.subscription[0].modules_limit }}</small>
                      {% else %}
                        <span class="text-muted">No modules selected</span>
                      {% endif %}
                    {% else %}
                      <span class="text-muted">No subscription</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if company.subscription and company.subscription[0] %}
                      <span class="badge bg-{{ 'warning' if company.subscription[0].plan_type == 'free' else 'success' }}">
                        {{ company.subscription[0].plan_name }}
                      </span>
                    {% else %}
                      <span class="badge bg-danger">No Plan</span>
                    {% endif %}
                  </td>
                  <td>
                    <small>{{ company.created_at.strftime('%Y-%m-%d') if company.created_at else 'Unknown' }}</small>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm">
                      <button class="btn btn-outline-primary" onclick="viewCompany('{{ company.id }}')" title="View Company Details">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button class="btn btn-outline-info" onclick="contactAdmin('{{ company.id }}')" title="Contact Admin">
                        <i class="fas fa-envelope"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Initialize DataTable for better table functionality
document.addEventListener('DOMContentLoaded', function() {
  if (typeof DataTable !== 'undefined') {
    $('#companiesTable').DataTable({
      pageLength: 25,
      order: [[8, 'desc']], // Sort by created date
      columnDefs: [
        { orderable: false, targets: [9] } // Disable sorting on actions column
      ]
    });
  }
});

function viewCompany(companyId) {
  // Implement company details view
  alert(`View details for company ID: ${companyId}`);
}

function contactAdmin(companyId) {
  // Implement contact admin functionality
  alert(`Contact admin for company ID: ${companyId}`);
}

function exportData() {
  // Implement data export functionality
  window.location.href = '{{ url_for("founder_export_data") }}';
}

function refreshData() {
  window.location.reload();
}
</script>

<style>
.card {
  border: none;
  box-shadow: 0 0 20px rgba(0,0,0,0.1);
}

.table th {
  border-top: none;
  font-weight: 600;
}

.badge {
  font-size: 0.75rem;
}

.btn-group-sm > .btn {
  padding: 0.25rem 0.5rem;
}
</style>

{% endblock %}
